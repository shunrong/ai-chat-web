"use strict";(()=>{var e={};e.id=382,e.ids=[382],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},4325:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>l,patchFetch:()=>w,requestAsyncStorage:()=>u,routeModule:()=>c,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var r={};a.r(r),a.d(r,{POST:()=>p});var i=a(31545),s=a(97427),d=a(39216),n=a(50707),o=a(8889);async function p(e){let{phone:t}=await e.json();if(!t)return o.NextResponse.json({message:"缺少手机号"},{status:400});let a=Math.floor(1e5+9e5*Math.random()).toString(),r=new Date(Date.now()+6e5);return await n.m.setOtp(t,a,r),o.NextResponse.json({ok:!0,code:void 0})}let c=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/send-otp/route",pathname:"/api/auth/send-otp",filename:"route",bundlePath:"app/api/auth/send-otp/route"},resolvedPagePath:"/Users/lime/Code/ai-chat-web/app/api/auth/send-otp/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:u,staticGenerationAsyncStorage:m,serverHooks:h}=c,l="/api/auth/send-otp/route";function w(){return(0,d.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},50707:(e,t,a)=>{a.d(t,{m:()=>d});var r=a(74900),i=a.n(r),s=a(5688);let d={isMock:!1,findUserByPhone:async e=>await s.prisma.user.findFirst({where:{phone:e}}),async createUserWithPassword(e,t){let a=await i().hash(t,10);return await s.prisma.user.create({data:{phone:e,passwordHash:a}})},upsertUserByPhone:async e=>await s.prisma.user.upsert({where:{phone:e||"_"},update:{},create:{phone:e}}),async setOtp(e,t,a){await s.prisma.verificationToken.upsert({where:{identifier_token:{identifier:e,token:t}},update:{expires:a},create:{identifier:e,token:t,expires:a}})},verifyAndConsumeOtp:async(e,t)=>!!await s.prisma.verificationToken.findFirst({where:{identifier:e,token:t,expires:{gt:new Date}}})&&(await s.prisma.verificationToken.delete({where:{identifier_token:{identifier:e,token:t}}}),!0),listChats:async e=>await s.prisma.chat.findMany({where:{userId:e},orderBy:{updatedAt:"desc"},select:{id:!0,title:!0}}),createChat:async e=>({id:(await s.prisma.chat.create({data:{userId:e,title:"新对话"}})).id}),async getChatMessages(e,t){let a=await s.prisma.chat.findFirst({where:{id:t,userId:e},include:{messages:{orderBy:{createdAt:"asc"}}}});return a?.messages||[]},async addUserMessage(e,t,a){let r=`已收到：${a}`,i=await s.prisma.chat.findFirst({where:{id:t,userId:e}});if(!i)throw Error("Not Found");let d=await s.prisma.message.create({data:{chatId:i.id,role:"user",content:a}}),n=await s.prisma.message.create({data:{chatId:i.id,role:"assistant",content:r}});return await s.prisma.chat.update({where:{id:i.id},data:{updatedAt:new Date,title:d.content.slice(0,20)||i.title}}),{user:d,assistant:n}},async createUserMessage(e,t,a){let r=await s.prisma.chat.findFirst({where:{id:t,userId:e}});if(!r)throw Error("Not Found");let i=await s.prisma.message.create({data:{chatId:r.id,role:"user",content:a}});return await s.prisma.chat.update({where:{id:r.id},data:{updatedAt:new Date,title:i.content.slice(0,20)||r.title}}),i},async createAssistantMessage(e,t,a){let r=await s.prisma.chat.findFirst({where:{id:t,userId:e}});if(!r)throw Error("Not Found");let i=await s.prisma.message.create({data:{chatId:r.id,role:"assistant",content:a}});return await s.prisma.chat.update({where:{id:r.id},data:{updatedAt:new Date}}),i},listPrompts:async e=>(await s.prisma.promptSet.findMany({where:{userId:e},include:{prompts:!0},orderBy:{updatedAt:"desc"}})).flatMap(t=>t.prompts.map(t=>({id:t.id,userId:e,title:t.title,content:t.content,createdAt:t.createdAt,updatedAt:t.updatedAt}))),async addPrompt(e,t,a){let r=await s.prisma.promptSet.findFirst({where:{userId:e},orderBy:{createdAt:"asc"}});r||(r=await s.prisma.promptSet.create({data:{userId:e,title:"默认提示词集"}}));let i=await s.prisma.prompt.create({data:{promptSetId:r.id,title:t,content:a}});return{id:i.id,userId:e,title:i.title,content:i.content,createdAt:i.createdAt,updatedAt:i.updatedAt}}}},5688:(e,t,a)=>{a.r(t),a.d(t,{prisma:()=>i});let r=require("@prisma/client"),i=global.prisma||new r.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[471,475,889],()=>a(4325));module.exports=r})();