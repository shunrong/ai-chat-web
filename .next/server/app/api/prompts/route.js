"use strict";(()=>{var e={};e.id=437,e.ids=[437],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},45070:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>x,requestAsyncStorage:()=>w,routeModule:()=>l,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var a={};r.r(a),r.d(a,{GET:()=>u,POST:()=>m});var i=r(31545),s=r(97427),n=r(39216),d=r(5688),o=r(77477),p=r(43221),c=r(8889);async function u(){let e=await (0,o.getServerSession)(p.L);if(!e?.user?.id)return c.NextResponse.json({items:[]});let t=(await d.prisma.promptSet.findMany({where:{userId:e.user.id},include:{prompts:!0},orderBy:{updatedAt:"desc"}})).flatMap(e=>e.prompts.map(e=>({id:e.id,title:e.title,content:e.content})));return c.NextResponse.json({items:t})}async function m(e){let t=await (0,o.getServerSession)(p.L);if(!t?.user?.id)return new c.NextResponse("Unauthorized",{status:401});let{title:r,content:a}=await e.json();if(!r||!a)return new c.NextResponse("Bad Request",{status:400});let i=await d.prisma.promptSet.findFirst({where:{userId:t.user.id},orderBy:{createdAt:"asc"}});i||(i=await d.prisma.promptSet.create({data:{userId:t.user.id,title:"默认提示词集"}}));let s=await d.prisma.prompt.create({data:{promptSetId:i.id,title:r,content:a}});return c.NextResponse.json({item:s})}let l=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/prompts/route",pathname:"/api/prompts",filename:"route",bundlePath:"app/api/prompts/route"},resolvedPagePath:"/Users/lime/Code/ai-chat-web/app/api/prompts/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:h,serverHooks:f}=l,y="/api/prompts/route";function x(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},43221:(e,t,r)=>{let a;r.d(t,{L:()=>o});var i=r(54067),s=r(74900),n=r.n(s),d=r(50707);if(process.env.DATABASE_URL){let{PrismaAdapter:e}=r(86003),{prisma:t}=r(5688);a=e(t)}let o={adapter:a,session:{strategy:"database"},secret:process.env.NEXTAUTH_SECRET||void 0,callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id),e),session:async({session:e,token:t})=>(e.user&&t&&(e.user.id=t.id),e)},providers:[(0,i.Z)({id:"credentials",name:"Password",credentials:{phone:{},password:{}},async authorize(e){let t=(e?.phone||"").trim(),r=e?.password||"",a=await d.m.findUserByPhone(t);return a&&a.passwordHash&&await n().compare(r,a.passwordHash)?{id:a.id,name:a.name||a.phone||"用户"}:null}}),(0,i.Z)({id:"otp",name:"OTP",credentials:{phone:{},code:{}},async authorize(e){let t=(e?.phone||"").trim(),r=(e?.code||"").trim();if(!t||!r||!await d.m.verifyAndConsumeOtp(t,r))return null;let a=await d.m.upsertUserByPhone(t);return{id:a.id,name:a.name||t}}})],pages:{signIn:"/sign_in"}}},50707:(e,t,r)=>{r.d(t,{m:()=>n});var a=r(74900),i=r.n(a),s=r(5688);let n={isMock:!1,findUserByPhone:async e=>await s.prisma.user.findFirst({where:{phone:e}}),async createUserWithPassword(e,t){let r=await i().hash(t,10);return await s.prisma.user.create({data:{phone:e,passwordHash:r}})},upsertUserByPhone:async e=>await s.prisma.user.upsert({where:{phone:e||"_"},update:{},create:{phone:e}}),async setOtp(e,t,r){await s.prisma.verificationToken.upsert({where:{identifier_token:{identifier:e,token:t}},update:{expires:r},create:{identifier:e,token:t,expires:r}})},verifyAndConsumeOtp:async(e,t)=>!!await s.prisma.verificationToken.findFirst({where:{identifier:e,token:t,expires:{gt:new Date}}})&&(await s.prisma.verificationToken.delete({where:{identifier_token:{identifier:e,token:t}}}),!0),listChats:async e=>await s.prisma.chat.findMany({where:{userId:e},orderBy:{updatedAt:"desc"},select:{id:!0,title:!0}}),createChat:async e=>({id:(await s.prisma.chat.create({data:{userId:e,title:"新对话"}})).id}),async getChatMessages(e,t){let r=await s.prisma.chat.findFirst({where:{id:t,userId:e},include:{messages:{orderBy:{createdAt:"asc"}}}});return r?.messages||[]},async addUserMessage(e,t,r){let a=`已收到：${r}`,i=await s.prisma.chat.findFirst({where:{id:t,userId:e}});if(!i)throw Error("Not Found");let n=await s.prisma.message.create({data:{chatId:i.id,role:"user",content:r}}),d=await s.prisma.message.create({data:{chatId:i.id,role:"assistant",content:a}});return await s.prisma.chat.update({where:{id:i.id},data:{updatedAt:new Date,title:n.content.slice(0,20)||i.title}}),{user:n,assistant:d}},async createUserMessage(e,t,r){let a=await s.prisma.chat.findFirst({where:{id:t,userId:e}});if(!a)throw Error("Not Found");let i=await s.prisma.message.create({data:{chatId:a.id,role:"user",content:r}});return await s.prisma.chat.update({where:{id:a.id},data:{updatedAt:new Date,title:i.content.slice(0,20)||a.title}}),i},async createAssistantMessage(e,t,r){let a=await s.prisma.chat.findFirst({where:{id:t,userId:e}});if(!a)throw Error("Not Found");let i=await s.prisma.message.create({data:{chatId:a.id,role:"assistant",content:r}});return await s.prisma.chat.update({where:{id:a.id},data:{updatedAt:new Date}}),i},listPrompts:async e=>(await s.prisma.promptSet.findMany({where:{userId:e},include:{prompts:!0},orderBy:{updatedAt:"desc"}})).flatMap(t=>t.prompts.map(t=>({id:t.id,userId:e,title:t.title,content:t.content,createdAt:t.createdAt,updatedAt:t.updatedAt}))),async addPrompt(e,t,r){let a=await s.prisma.promptSet.findFirst({where:{userId:e},orderBy:{createdAt:"asc"}});a||(a=await s.prisma.promptSet.create({data:{userId:e,title:"默认提示词集"}}));let i=await s.prisma.prompt.create({data:{promptSetId:a.id,title:t,content:r}});return{id:i.id,userId:e,title:i.title,content:i.content,createdAt:i.createdAt,updatedAt:i.updatedAt}}}},5688:(e,t,r)=>{r.r(t),r.d(t,{prisma:()=>i});let a=require("@prisma/client"),i=global.prisma||new a.PrismaClient}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[471,475,889,797],()=>r(45070));module.exports=a})();