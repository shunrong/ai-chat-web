"use strict";(()=>{var e={};e.id=406,e.ids=[406],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},97101:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>y,patchFetch:()=>f,requestAsyncStorage:()=>m,routeModule:()=>l,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h});var r={};a.r(r),a.d(r,{GET:()=>u});var i=a(31545),s=a(97427),n=a(39216),d=a(50707),o=a(8889),p=a(77477),c=a(43221);async function u(e,{params:t}){let a=await (0,p.getServerSession)(c.L);if(!a?.user?.id)return new o.NextResponse("Unauthorized",{status:401});let r=await d.m.getChatMessages(a.user.id,t.id);return r?o.NextResponse.json({messages:r}):new o.NextResponse("Not Found",{status:404})}let l=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/chat/[id]/route",pathname:"/api/chat/[id]",filename:"route",bundlePath:"app/api/chat/[id]/route"},resolvedPagePath:"/Users/lime/Code/ai-chat-web/app/api/chat/[id]/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:w}=l,y="/api/chat/[id]/route";function f(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}},43221:(e,t,a)=>{let r;a.d(t,{L:()=>o});var i=a(54067),s=a(74900),n=a.n(s),d=a(50707);if(process.env.DATABASE_URL){let{PrismaAdapter:e}=a(86003),{prisma:t}=a(5688);r=e(t)}let o={adapter:r,session:{strategy:"database"},secret:process.env.NEXTAUTH_SECRET||void 0,callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id),e),session:async({session:e,token:t})=>(e.user&&t&&(e.user.id=t.id),e)},providers:[(0,i.Z)({id:"credentials",name:"Password",credentials:{phone:{},password:{}},async authorize(e){let t=(e?.phone||"").trim(),a=e?.password||"",r=await d.m.findUserByPhone(t);return r&&r.passwordHash&&await n().compare(a,r.passwordHash)?{id:r.id,name:r.name||r.phone||"用户"}:null}}),(0,i.Z)({id:"otp",name:"OTP",credentials:{phone:{},code:{}},async authorize(e){let t=(e?.phone||"").trim(),a=(e?.code||"").trim();if(!t||!a||!await d.m.verifyAndConsumeOtp(t,a))return null;let r=await d.m.upsertUserByPhone(t);return{id:r.id,name:r.name||t}}})],pages:{signIn:"/sign_in"}}},50707:(e,t,a)=>{a.d(t,{m:()=>n});var r=a(74900),i=a.n(r),s=a(5688);let n={isMock:!1,findUserByPhone:async e=>await s.prisma.user.findFirst({where:{phone:e}}),async createUserWithPassword(e,t){let a=await i().hash(t,10);return await s.prisma.user.create({data:{phone:e,passwordHash:a}})},upsertUserByPhone:async e=>await s.prisma.user.upsert({where:{phone:e||"_"},update:{},create:{phone:e}}),async setOtp(e,t,a){await s.prisma.verificationToken.upsert({where:{identifier_token:{identifier:e,token:t}},update:{expires:a},create:{identifier:e,token:t,expires:a}})},verifyAndConsumeOtp:async(e,t)=>!!await s.prisma.verificationToken.findFirst({where:{identifier:e,token:t,expires:{gt:new Date}}})&&(await s.prisma.verificationToken.delete({where:{identifier_token:{identifier:e,token:t}}}),!0),listChats:async e=>await s.prisma.chat.findMany({where:{userId:e},orderBy:{updatedAt:"desc"},select:{id:!0,title:!0}}),createChat:async e=>({id:(await s.prisma.chat.create({data:{userId:e,title:"新对话"}})).id}),async getChatMessages(e,t){let a=await s.prisma.chat.findFirst({where:{id:t,userId:e},include:{messages:{orderBy:{createdAt:"asc"}}}});return a?.messages||[]},async addUserMessage(e,t,a){let r=`已收到：${a}`,i=await s.prisma.chat.findFirst({where:{id:t,userId:e}});if(!i)throw Error("Not Found");let n=await s.prisma.message.create({data:{chatId:i.id,role:"user",content:a}}),d=await s.prisma.message.create({data:{chatId:i.id,role:"assistant",content:r}});return await s.prisma.chat.update({where:{id:i.id},data:{updatedAt:new Date,title:n.content.slice(0,20)||i.title}}),{user:n,assistant:d}},async createUserMessage(e,t,a){let r=await s.prisma.chat.findFirst({where:{id:t,userId:e}});if(!r)throw Error("Not Found");let i=await s.prisma.message.create({data:{chatId:r.id,role:"user",content:a}});return await s.prisma.chat.update({where:{id:r.id},data:{updatedAt:new Date,title:i.content.slice(0,20)||r.title}}),i},async createAssistantMessage(e,t,a){let r=await s.prisma.chat.findFirst({where:{id:t,userId:e}});if(!r)throw Error("Not Found");let i=await s.prisma.message.create({data:{chatId:r.id,role:"assistant",content:a}});return await s.prisma.chat.update({where:{id:r.id},data:{updatedAt:new Date}}),i},listPrompts:async e=>(await s.prisma.promptSet.findMany({where:{userId:e},include:{prompts:!0},orderBy:{updatedAt:"desc"}})).flatMap(t=>t.prompts.map(t=>({id:t.id,userId:e,title:t.title,content:t.content,createdAt:t.createdAt,updatedAt:t.updatedAt}))),async addPrompt(e,t,a){let r=await s.prisma.promptSet.findFirst({where:{userId:e},orderBy:{createdAt:"asc"}});r||(r=await s.prisma.promptSet.create({data:{userId:e,title:"默认提示词集"}}));let i=await s.prisma.prompt.create({data:{promptSetId:r.id,title:t,content:a}});return{id:i.id,userId:e,title:i.title,content:i.content,createdAt:i.createdAt,updatedAt:i.updatedAt}}}},5688:(e,t,a)=>{a.r(t),a.d(t,{prisma:()=>i});let r=require("@prisma/client"),i=global.prisma||new r.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[471,475,889,797],()=>a(97101));module.exports=r})();